# WMS 前端 + 后端 Nginx 部署文档（CentOS/RHEL）

## 概述
- 前端（Vue 构建产物）通过 Nginx 提供静态资源与 SPA 路由
- 后端（Spring Boot）运行在 127.0.0.1:8080，通过 Nginx 以 `/api` 前缀反向代理
- 公网访问 IP: `http://8.137.116.128/`

---

## 环境与路径
- Nginx 运行用户: `nginx`
- 前端静态目录: `/var/www/wms-web`
- 后端服务: `127.0.0.1:8080`（Spring Boot）
- 反代前缀: `/api`（前端访问 `/api/v1/**`，无需 rewrite）

---

## 最终 Nginx 配置（完整文件：/etc/nginx/nginx.conf）

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 4096;
    client_max_body_size 50M;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    server_tokens off;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    upstream wms_backend {
        server 127.0.0.1:8080;
        keepalive 32;
    }

    # 如出现冲突，可先注释以下 include，再逐步恢复
    # include /etc/nginx/conf.d/*.conf;
    # include /etc/nginx/default.d/*.conf;

    server {
        listen       80;
        listen       [::]:80;
        server_name  _;

        root         /var/www/wms-web;
        index        index.html;

        # 前端 SPA 路由兜底
        location / {
            try_files $uri $uri/ /index.html;
        }

        # 接口反向代理
        location /api/ {
            proxy_pass http://wms_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 静态资源缓存（可选）
        location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
            access_log off;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000, immutable";
            try_files $uri =404;
        }
    }
}
```

---

## 部署步骤（前端 + Nginx）

1. 上传前端打包产物
```bash
sudo mkdir -p /var/www/wms-web
sudo rsync -av /path/to/dist/ /var/www/wms-web/
```

2. 统一权限（CentOS/RHEL，用户 nginx）
```bash
sudo chown -R nginx:nginx /var/www/wms-web
sudo find /var/www/wms-web -type d -exec chmod 755 {} \;
sudo find /var/www/wms-web -type f -exec chmod 644 {} \;
sudo chmod 755 /var/www /var/www/wms-web
```

3. SELinux（如开启）
```bash
getenforce | grep -q Enforcing && \
sudo chcon -R -t httpd_sys_content_t /var/www/wms-web && \
sudo restorecon -R /var/www/wms-web
```

4. 生效配置
```bash
sudo nginx -t && sudo systemctl reload nginx
```

5. 安全组/防火墙
- 放通 80/TCP

6. 访问
- 浏览器访问 `http://8.137.116.128/`（不要访问 `/index`）

---

## 验证清单

- 服务状态
```bash
sudo nginx -t && systemctl status nginx
```

- 本地回环验证
```bash
curl -I http://127.0.0.1/
```

- 反代验证（对比后端直连）
```bash
curl -i "http://127.0.0.1:8080/api/v1/auth/captcha/init"
curl -i "http://8.137.116.128/api/v1/auth/captcha/init"
```

- 端口检查
```bash
sudo ss -tulpn | grep -E ':80|:8080'
```

- 冲突配置定位（如需）
```bash
sudo grep -R "listen 80" -n /etc/nginx
sudo grep -R "server_name" -n /etc/nginx
sudo grep -R "root " -n /etc/nginx
```

---

## 故障与处理记录（本次问题）

- 问题1：Nginx 启动失败（端口 8080 冲突）
  - 症状: `bind() to 0.0.0.0:8080 failed (98: Address already in use)`
  - 原因: 配置存在 `server { listen 8080; }` 与后端冲突
  - 处理: 删除/注释该 8080 的 `server`，只保留 80 端口站点

- 问题2：重复 `location /` 导致语法错误
  - 症状: `duplicate location "/" in nginx.conf`
  - 原因: 同一 `server` 中出现两个 `location /`
  - 处理: 保留 SPA `location /`，将 API 反代改为 `location /api/`

- 问题3：500/权限拒绝（静态目录在 /root）
  - 症状: `stat() "/root/workspace/web/index.html" failed (13: Permission denied)`
  - 原因: 站点根目录在 `/root`，Nginx 无权限访问；访问 `/index` 引发内部重定向循环
  - 处理: 静态目录迁移至 `/var/www/wms-web`，修正 `root`、权限与 SELinux；访问用 `/`

- 问题4：403 Forbidden（目录索引被禁止/配置被覆盖）
  - 症状: `directory index of "/var/" is forbidden`
  - 原因: 被 `conf.d`/`default.d` 中其它 server 覆盖或错误 `root`
  - 处理: 暂注释 include，仅保留一个 80 server 验证通过；逐步恢复 include，定位并修正冲突文件

- 问题5：接口 400：`Fontconfig head is null...`（后端）
  - 判定: 后端业务错误（与 Nginx 无关）
  - 原因: 生成验证码依赖 Fontconfig/字体，系统未安装字体
  - 处理（CentOS/RHEL）:
    ```bash
    sudo yum install -y fontconfig freetype \
      dejavu-sans-fonts dejavu-serif-fonts dejavu-sans-mono-fonts
    sudo yum install -y epel-release
    sudo yum install -y wqy-zenhei-fonts wqy-microhei-fonts || true
    sudo yum install -y google-noto-sans-cjk-ttc || true
    sudo fc-cache -fv
    # 重启后端，建议加 -Djava.awt.headless=true
    ```

---

## 运维建议
- 保持唯一 80 端口默认站点；多站点需精确 `server_name`
- SPA 必须保留 `try_files $uri $uri/ /index.html;`
- 反向代理使用 `/api/` 前缀，后端挂载 `/api/v1/**`，减少 rewrite 复杂度
- 静态目录固定 `/var/www/<app>`，避免 `/root`
- 定期检查 `/var/log/nginx/access.log` 与 `/var/log/nginx/error.log`
- 若启用 SELinux，确保目录上下文为 `httpd_sys_content_t`